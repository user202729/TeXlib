%! TEX program = pdflatex
\documentclass[a5paper]{article}
\errorcontextlines=5
\usepackage{prettytok}
\prettyinitterm
\ExplSyntaxOn
\pretty:n{going to load}
\ExplSyntaxOff
\usepackage[mode=multiprocessing_network]{pythonimmediate}
%\usepackage[mode=unnamed_pipe]{pythonimmediate}








\ExplSyntaxOn
\pretty:n{1.start}

\begin{pythonimmediateenv}
import pythonimmediate

x="xxx"
import sys
print("======== test stdout ========")
print("======== test stderr ========", file=sys.stderr)

print=pythonimmediate.print
pythonimmediate.run_tokenized_line_finish(r'\pretty:n {2.a}')
\end{pythonimmediateenv}

\pythonimmediateverb|pythonimmediate.run_block_finish(r'\pretty:n {3.xxx~ =~ ' + x + '}')|

\begin{pythonimmediateenv}
pythonimmediate.run_block_finish(r'''
\pretty:n {4.}
\pythonimmediateverb|pythonimmediate.run_tokenized_line_finish(r'\pretty:n{5.}')|
\pretty:n {6.}
''')
\end{pythonimmediateenv}

\begin{pythonimmediateenv}

x=123

pythonimmediate.run_tokenized_line_peek(
r'\pretty:n{7.} \pythonimmediate:n{x=456} \pretty:n{8.} \pythonimmediatecontinue {}'
)

assert x==456

content=pythonimmediate.run_tokenized_line_peek(r'\pythonimmediatecontinue {abc~~def}')
assert "abc def"==content, content

pythonimmediate.run_tokenized_line_finish(
r'\pretty:n{9.}'
)
\end{pythonimmediateenv}

\pretty:n{10.}


\ExplSyntaxOff


\begin{document}




1+1=\py{1+1}.

\pyc{x=3}

x=\py{x}.

% \pyc{print("%")}  % ‚Üê error!

x=\pyc{print(str(x), end="")}.  % without trailing space. Note that this requires % to have the "comment" catcode.

x=\pyc{print(str(x))}.  % there's an extra space.

% "escaped" things are passed "verbatim" to Python. There's no way to pass a single backslash to it.
\py{len(r"\\")}=2.

% values are not expanded before being passed to Python.
\def\myvalue{123}
\py{len(r"\myvalue")}  % 9, which is the string

\py{r"\verb|\myvalue |"}% print "\myvalue" verbatim (because of tokenization a space will be added)
\py{r"\myvalue"}  % print "\myvalue" to TeX, however TeX will execute \myvalue and typeset 123

\verb|\myvalue|\myvalue

\begin{pycode}
print("11.\n", file=sys.stderr)
\end{pycode}


\begin{pycode}
@pythonimmediate.newcommand
def pyvmanual():
	return eval(pythonimmediate.get_verbatim_argument())
\end{pycode}



\pyv{r"\verb|\myvalue|"}%
\pyv{r"\myvalue"}  %  use pyv to avoid tokenization

\pyvmanual{r"\verb|\myvalue|"}%
\pyvmanual{r"\myvalue"}  %  use pyv to avoid tokenization


\begin{pycode}
assert ("""
   
""").count(' ')==3

x=1

# ======== test newcommand ========
@pythonimmediate.newcommand
def testa():
	global x
	x=2

assert x==1
pythonimmediate.run_tokenized_line_local(r'\testa')
assert x==2

# ======== test newcommand with name provided ========
@pythonimmediate.newcommand("testd")
def testa():
	global x
	x=3

assert x==2
pythonimmediate.run_tokenized_line_local(r'\testd')
assert x==3

@pythonimmediate.renewcommand
def testa():
	global x, y
	x=pythonimmediate.get_argument_detokenized()
	y=pythonimmediate.get_argument_detokenized()


def assertEqual(x, y):
	assert x==y, (x, y)


pythonimmediate.run_tokenized_line_local(r'\testa {123} {456}')
assertEqual(x, "123")
assertEqual(y, "456")


# ======== test: renewcommand on non-Python-defined command
pythonimmediate.run_tokenized_line_local(r'\def \testb {}')

@pythonimmediate.renewcommand
def testb(): pass



@pythonimmediate.newcommand
def testc():
	assertEqual(pythonimmediate.get_argument_detokenized(), "ab")
	assertEqual(pythonimmediate.get_optional_argument_detokenized(), "cd")
	assertEqual(pythonimmediate.get_optional_argument_detokenized(), None)
	assertEqual(pythonimmediate.get_verbatim_argument(), "ef")
	assertEqual(pythonimmediate.get_optional_argument_detokenized(), None)
	assertEqual(pythonimmediate.get_verbatim_argument(), "gh")
	assertEqual(pythonimmediate.get_multiline_verbatim_argument(), "ijk\nlm")
	print("123", end="")
	return "456"

pythonimmediate.run_tokenized_line_local("789%")
pythonimmediate.run_tokenized_line_local("789%")

pythonimmediate.run_block_local(r'''\testc {ab} [cd]|ef|{gh}|ijk
lm|%''')

pythonimmediate.run_tokenized_line_local("789%")



@pythonimmediate.renewcommand
def testd():
	a=pythonimmediate.get_argument_tokenlist()
	print(f"{a=}", file=sys.stderr)

	pythonimmediate.put_next(r'{123}')
	b=pythonimmediate.get_argument_tokenlist()
	print(f"{b=}", file=sys.stderr)

	pythonimmediate.put_next(r'{1 a\relax}')
	for t, meaning in [
			(pythonimmediate.CharacterToken(ord('{'), pythonimmediate.Catcode.bgroup), "begin-group character {"),
			(pythonimmediate.CharacterToken(ord('1'), pythonimmediate.Catcode.other), "the character 1"),
			(pythonimmediate.CharacterToken(ord(' '), pythonimmediate.Catcode.space), "blank space  "),
			(pythonimmediate.CharacterToken(ord('a'), pythonimmediate.Catcode.letter), "the letter a"),
			(pythonimmediate.ControlSequenceToken('relax'), r"\relax"),
			(pythonimmediate.CharacterToken(ord('}'), pythonimmediate.Catcode.egroup), "end-group character }"),
			]:
		assertEqual(pythonimmediate.peek_next_meaning(), meaning)
		assertEqual(pythonimmediate.peek_next_token(), t)
		assertEqual(pythonimmediate.get_next_token(), t)

	pythonimmediate.put_next(pythonimmediate.frozen_relax_token)
	assertEqual(pythonimmediate.peek_next_token(), pythonimmediate.frozen_relax_token)
	assertEqual(pythonimmediate.get_next_token(), pythonimmediate.frozen_relax_token)

	pythonimmediate.put_next(a)
	c=pythonimmediate.get_argument_tokenlist()
	print(f"{c=}", file=sys.stderr)

	assert c==a[1:-1]

pythonimmediate.run_block_local(
r'''
\precattlExec{ \testd {{ab\cC {}\cC{123}\relax\cFrozenRelax {}\cP*$^_ \cS\a}} }
''')
\end{pycode}
\end{document}
