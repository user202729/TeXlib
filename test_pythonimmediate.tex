%! TEX program = pdflatex
\documentclass[a5paper]{article}
\errorcontextlines=5
\usepackage{prettytok}
\prettyinitterm
\ExplSyntaxOn
\pretty:n{going to load}
\ExplSyntaxOff
\usepackage[mode=multiprocessing_network]{pythonimmediate}
%\usepackage[mode=unnamed_pipe]{pythonimmediate}

\ExplSyntaxOn
\pretty:n{1.start}

\begin{pythonimmediateenv}
import pythonimmediate
x="xxx"
import sys
print("======== test stdout ========")
print("======== test stderr ========", file=sys.stderr)
pythonimmediate.run_tokenized_line_finish(r'\pretty:n {2.a}')
\end{pythonimmediateenv}

\pythonimmediateverb|pythonimmediate.run_block_finish(r'\pretty:n {3.xxx~ =~ ' + x + '}')|

\begin{pythonimmediateenv}
pythonimmediate.run_block_finish(r'''
\pretty:n {4.}
\pythonimmediateverb|pythonimmediate.run_tokenized_line_finish(r'\pretty:n{5.}')|
\pretty:n {6.}
''')
\end{pythonimmediateenv}

\begin{pythonimmediateenv}

x=123

pythonimmediate.run_tokenized_line_peek(
r'\pretty:n{7.} \pythonimmediate:n{x=456} \pretty:n{8.} \pythonimmediatecontinue {}'
)

assert x==456

content=pythonimmediate.run_tokenized_line_peek(r'\pythonimmediatecontinue {abc~~def}')
assert "abc def"==content, content

pythonimmediate.run_tokenized_line_finish(
r'\pretty:n{9.}'
)
\end{pythonimmediateenv}

\pretty:n{10.}


\ExplSyntaxOff


\begin{document}
1+1=\py{1+1}.

\pyc{x=3}

x=\py{x}.

% \pyc{print("%")}  % ‚Üê error!

x=\pyc{print(str(x), end="")}.  % without trailing space. Note that this requires % to have the "comment" catcode.

x=\pyc{print(str(x))}.  % there's an extra space.

% "escaped" things are passed "verbatim" to Python. There's no way to pass a single backslash to it.
\py{len(r"\\")}=2.

% values are not expanded before being passed to Python.
\def\myvalue{123}
\py{len(r"\myvalue")}  % 9, which is the string
\py{r"\verb|\myvalue|"}  % print "\myvalue" verbatim

\begin{pycode}
assert ("""
   
""").count(' ')==3
\end{pycode}

\begin{pycode}
print(r"\verb*|%  %|")
print(1/0)
\end{pycode}

\end{document}
